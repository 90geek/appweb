#!/bin/bash
#
#   patchAppwebConf -- Patch the appweb.conf file
#   Copyright (c) Embedthis Software LLC, 2003-2011. All Rights Reserved.
#
#   usage: $BLD_TOOLS_DIR/patchAppwebConf file 
#
#   Must set the env vars:
#       BLD_CFG_PREFIX, BLD_WEB_PREFIX, BLD_HTTP_PORT, BLD_SSL_PORT
#
###############################################################################

setup() {
    local g u

    #
    #   Select default username
    #
    for u in www-data _www nobody Administrator
    do
        grep "$u" /etc/passwd >/dev/null
        if [ $? = 0 ]
        then
            username=$u
            break
        fi
    done

    if [ "$username" = "" ] ; then
        echo "Can't find a suitable username in /etc/passwd for $PRODUCT" 1>&2
        exit 255
    fi
    
    #
    #   Select default group name
    #
    for g in www-data _www nogroup nobody Administrators
    do
        grep "$g" /etc/group >/dev/null
        if [ $? = 0 ]
        then
            groupname=$g
            break
        fi
    done
    
    if [ "$groupname" = "" ] ; then
        echo "Can't find a suitable group in /etc/group for $PRODUCT" 1>&2
        exit 255
    fi

    if [ "$ORIG_BLD_CFG_PREFIX" != "" ] ; then
        for v in BLD_CFG_PREFIX BLD_WEB_PREFIX BLD_DOC_PREFIX BLD_LIB_PREFIX BLD_LOG_PREFIX ; do
            eval export $v=$`echo ORIG_${v}`
        done
    fi
}



editAppwebConf()
{
    conf="$1"
    ssl="$2"
    log="$3"
    doc="$4"
    docPrefix="${BLD_DOC_PREFIX}"
    
    if [ -f "$conf" ] ; then
        sed -e <"$conf" >"$conf.new" "
            s!^ServerRoot.*\".*!ServerRoot \"${BLD_CFG_PREFIX}\"!
            s!^DocumentRoot.*\".*!DocumentRoot \"${BLD_WEB_PREFIX}\"!
            s!^LoadModulePath.*\".*!LoadModulePath \"${BLD_LIB_PREFIX}\"!
            s!EspDir cache.*!EspDir cache \"${BLD_SPL_PREFIX}/cache\"!
            s!^Listen.*!Listen ${BLD_HTTP_PORT}!
            s!^User .*!User ${username}!
            s!ErrorLog.*error.log!ErrorLog \"${BLD_LOG_PREFIX}/error.log\"!
            s!AccessLog.*access.log!AccessLog \"${BLD_LOG_PREFIX}/access.log\"!
            s!Alias /doc/.*!Alias /doc/ \"${docPrefix}\/\"!
            s![ 	][ 	]*Listen.*!    Listen ${BLD_SSL_PORT}!
            s!DocumentRoot.*!DocumentRoot \"${BLD_WEB_PREFIX}\"!
            s!<VirtualHost .*!<VirtualHost *:${BLD_SSL_PORT}>!
            s!^Group .*!Group ${groupname}!"
        [ $? = 0 ] && mv "$conf.new" "$conf"
    fi

    if [ `uname | sed 's/CYGWIN.*/CYGWIN/'` = CYGWIN ] ; then
        if which unix2dos >/dev/null 2>&1 ; then
            unix2dos "$conf" >/dev/null 2>&1
            unix2dos "$ssl" >/dev/null 2>&1
            unix2dos "$log" >/dev/null 2>&1
            unix2dos "$doc" >/dev/null 2>&1
        fi
    else
        for f in "$conf" "$ssl" "$log" "$doc" ; do
            if [ -f "$f" ] ; then
                sed -e "s/$//" <"$f" >"$f".new
                [ $? = 0 ] && mv "$f.new" "$f"
            fi
        done
    fi
}


###############################################################################
#
#   Main
#

setup

if [ $# = 1 ] ; then
    editAppwebConf "$1"
else
    editAppwebConf "$1"
fi
