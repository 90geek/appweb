#!/bin/bash
#
#   cacheConfig -- Cache a copy of buildConfig.h as .buildConfig.sh suitable for use by shell scripts.
#   
#   Echos the path to the cache file so it can be used as:
#
#   . `cacheConfig ${BLD_INC_DIR}/buildConfig.h`
#
#   Copyright (c) Embedthis LLC, 2003-2011. All Rights Reserved.
#
config="$1"
cache="`dirname "$1"`/.buildConfig.sh"

if [ "$cache" -ot "$config" ] ; then
    (
        if grep 'C Source Code Definitions' <$config 2>&1 >/dev/null ; then
            cat "$config" | sed '1,/C Source Code/d'
        else 
            cat "$config" 
        fi
    ) | \
tee a.tmp |    sed 's/.*#define /ZZZ/;/ZZZ/s/ /=/;s/ZZZ//' | \
tee b.tmp |    sed 's/#if \(.*\)/if [ "$\1" = 1 ] ; then/' | \
tee c.tmp |    sed 's/#else/else/' | \
tee d.tmp |    sed 's/#endif/fi/' | \
tee e.tmp |    egrep -v 'IGNORE|^endif|^[ 	]*//' >"$cache"
fi
echo $cache
